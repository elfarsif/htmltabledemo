<!doctype html>
<meta charset="utf-8" />
<div id="vis"></div>

<script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
<script src="https://cdn.jsdelivr.net/npm/topojson-client@3"></script>
<script>
(async function () {
  const width = 960, height = 520;

  const svg = d3.select("#vis")
    .append("svg")
    .attr("width", width)
    .attr("height", height);

  // Simple tooltip
  const tip = d3.select("body")
    .append("div")
    .style("position", "fixed")
    .style("pointer-events", "none")
    .style("padding", "6px 8px")
    .style("border", "1px solid #ccc")
    .style("background", "white")
    .style("font", "12px system-ui")
    .style("display", "none");

  // Demo points (pretend these were extracted from a contract + geocoded)
  const points = [
    { name: "Toronto Office", lat: 43.6532, lon: -79.3832, count: 4 },
    { name: "Vancouver Site", lat: 49.2827, lon: -123.1207, count: 2 },
    { name: "New York Vendor", lat: 40.7128, lon: -74.0060, count: 5 },
  ];

  // World map data (TopoJSON)
  const world = await d3.json("https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json");
  const countries = topojson.feature(world, world.objects.countries);

  const projection = d3.geoNaturalEarth1()
    .fitSize([width, height], countries);

  const path = d3.geoPath(projection);

  // Draw map
  svg.append("g")
    .selectAll("path")
    .data(countries.features)
    .join("path")
    .attr("d", path)
    .attr("fill", "#f3f4f6")
    .attr("stroke", "#cbd5e1")
    .attr("stroke-width", 0.6);

  // Plot dots
  svg.append("g")
    .selectAll("circle")
    .data(points)
    .join("circle")
    .attr("cx", d => projection([d.lon, d.lat])[0])
    .attr("cy", d => projection([d.lon, d.lat])[1])
    .attr("r", d => 3 + d.count) // scale by something (e.g., # of mentions/risks)
    .attr("fill", "#111827")
    .attr("opacity", 0.85)
    .on("mousemove", (event, d) => {
      tip.style("display", "block")
        .style("left", (event.clientX + 12) + "px")
        .style("top", (event.clientY + 12) + "px")
        .html(`<b>${d.name}</b><br/>Mentions: ${d.count}`);
    })
    .on("mouseleave", () => tip.style("display", "none"));
})();
</script>
